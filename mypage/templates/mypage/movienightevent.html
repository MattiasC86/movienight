{% extends 'mypage/base.html' %}
{% block title %} {{ movienight.title }} - MovieNight Event {% endblock %}
{% load static %}

{% block body %}

    <div class="container">
        <div class="col-lg-12 mt-3">
            <h1 style="color:deepskyblue">{{ movienight.title }}</h1>
            <p class="text-muted">Created {{ movienight.creation_date }} by <a href="/user/{{ movienight.creator.username }}" style="color:limegreen">{{ movienight.creator.username }}</a></p>
            <hr class="bg-secondary">
        </div>
    </div>

    <div class="container mt-3">
        <div class="row">
            <div class="col-lg-8">
                <div class="mx-auto">
                    <p class="text-light">{{ movienight.description }}</p>
                    <img class="img-fluid" src="{{ movienight.decoration_url }}" alt="" style="max-height:500px">
                </div>
                <div class="mt-5  mb-5 mx-auto">
                    <h5 class="bg-dark text-light mb-0 p-1 border border-light">CHAT</h5>
                    <div class="bg-light mb-1" style="max-height:150px;overflow:scroll" id="chatWindow">
                        <p>User1: Hall책</p>
                        <p>User2: Hej d채r!</p>
                        <p>User3: Trevligt...</p>
                        <p>User2: Jo r채tt s책.</p>
                        <p>User3: Ja det tycker jag.</p>
                    </div>
                    <div class="input-group">
                        <input class="form-control col-lg-5" type="text" id="chatMessage" placeholder="Write your message...">
                        <span class="input-group-btn">
                            <button class="btn btn-secondary" type="button" id="sendMessageBtn">Send</button>
                        </span>
                    </div>

                </div>




            </div>

            {% comment %}<div class="col-xs-9 col-sm-9 col-md-9 col-lg-9 ml-auto">
                <div class="row">
                {% for movie in movies %}
                    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4 mt-3">
                        <h6 style="color:deepskyblue">{{ movie.Title }} <span class="text-muted">({{ movie.Year }})</span></h6>
                        <img class="img-fluid" src="{{ movie.Poster }}" alt="">
                    <button class="btn btn-success addBacklogMultiChoiceBtn" id="{{ movie.Title }}">+ Add to backlog</button>
                    </div>
                {% endfor %}
                </div>
            </div>{% endcomment %}

            {% comment %}<div class="col-xs-12 col-sm-12 col-md-9 col-lg-9" id="votedMovies">
                <div class="row">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-4">
                        <img class="img-fluid" id="resultPoster" src="" alt="">
                    </div>
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-5">
                        <h1 style="color:deepskyblue" id="resultTitle"></h1>
                        <span class="text-muted">Release year: </span><span class="text-white" id="resultYear"></span>
                        <br><span class="text-muted">Director: </span><span class="text-white" id="resultDirector"></span>
                        <br><span class="text-muted">Plot:</span>
                        <p class="text-white" id="resultPlot"></p>
                        <br>
                        <button class="btn btn-success addMovieBtn" id="resultTitle">+ Add to list</button>
                    </div>
                </div>
            </div>{% endcomment %}




            <!-- RIGHT SIDE -->
            <div class="col-xs-3 col-sm-3 col-md-3 col-lg-4">
                {% if movienight.creator == request.user %}
                <div class="mb-4">
                    <button class="btn btn-outline-secondary" data-toggle="modal" data-target="#eventSettingsModal">Event settings</button>
                    <button class="btn btn-outline-success" data-toggle="modal" data-target="#inviteUserModal">+ Invite user</button>
                    <form method="post" action="{{ request.build_absolute_uri }}delete">
                        {% csrf_token %}
                        <button class="btn btn-outline-danger" type="submit">Delete event</button>
                    </form>
                    <button class="btn btn-outline-success" id ="voteResultsBtn">Calculate results</button>
                </div>
                {% endif %}
                <div class="mt-4">
                    <h5 class="bg-secondary">WHEN & WHERE</h5>
                    <span class="text-light">{{ display_date }}<span class="text-muted"> @ </span>{{ movienight.location }}</span>
                </div>

                <div class="mt-4">
                    <h5 style="background:limegreen">PARTICIPANTS</h5>
                    <a href="/user/{{ movienight.creator.username }}" class="text-white">{{ movienight.creator.username }} <span style="color:deepskyblue">(Creator)</span></a>
                </div>
                {% for u in movienight.users.all %}
                    <div>
                        <a href="/user/{{ u.username }}" class="text-white">{{ u.username }}</a>
                    </div>
                {% endfor %}
                <div class="mt-4 mb-4">
                    <h5 style="background:orange">SUBMITTED MOVIE LISTS</h5>
                    <p class="text-muted">Max number of movies to nominate per user: <span style="color:orange"> {{ movienight.list_size }}</span></p>
                    <a href="{{ request.user.username }}/" class="text-white">Edit your movie list</a>
                </div>
                <span style="color:orange">VOTE:</span>
                {% for u in movienight.users.all %}
                    <div>
                        <a href="vote/{{ u.username }}/" class="text-white">Movie list by {{ u.username }}</a>
                        {% for l in movie_lists %}
                            {% if u.username == l.user.username %}
                                {% if l.users_voted.all %}
                                    <span class="text-muted">(Have voted: {% for uv in l.users_voted.all %} {{ uv.username }}{% endfor %})</span>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="container" id="votedMovies">
        <h2 class="text-info text-center">Voting Results</h2>
        <hr class="bg-light">
    </div>


    <!-- Settings Modal -->
<div class="modal fade" id="eventSettingsModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content" style="background:deepskyblue">
      <div class="modal-header bg-dark" style="color:deepskyblue">
        <h5 class="modal-title" id="exampleModalLabel">Event settings</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body bg-dark">
        <form class="form-horizontal" role="form" action="settings/" method="post">
                {% csrf_token %}
                <div class="form-group">
                    <div class="col-sm-10">
                        <label class="control-label col-sm-12 text-muted">Event description:</label>
                        <div class="col-sm-12">
                            <textarea cols="35" rows="5" name="description" placeholder="Description..." style="resize:none;overflow-x: hidden;">{{ movienight.description }}</textarea>
                        </div>
                        <label class="control-label col-sm-12 text-muted mt-2">Date & Time</label>
                        <div class="form-row col-sm-12">
                            <div class="col-sm-7">
                                <input class="form-control" type="date" max="2999-12-31" name="date" placeholder="" value="{{ usable_date }}">
                            </div>
                            <div class="col-sm-4">
                                <input class="form-control" type="time" max="23:59:59" name="time" placeholder="" value="{{ usable_time }}">
                            </div>
                        </div>

                        <label class="control-label col-sm-12 text-muted mt-2">Location</label>
                        <div class="col-sm-10">
                            <input class="form-control" type="text" name="location" placeholder="Location or address..." value="{{ movienight.location }}">
                        </div>
                        <label class="control-label col-sm-12 text-muted mt-2">Image upload:</label>
                        <div class="col-sm-10">
                            <input class="form-control" type="url" name="decoration" placeholder="URL to image..." value="{{ movienight.decoration_url }}">
                        </div>
                        <label class="control-label col-sm-12 text-muted mt-2">Max number of movies users can nominate:</label>
                        <div class="col-sm-10">
                            <select name="nrmovies" id="">
                                <option value="1"> 1 </option>
                                <option value="2"> 2 </option>
                                <option value="3"> 3 </option>
                                <option value="4"> 4 </option>
                                <option value="5"> 5 </option>
                            </select>
                        </div>
                        <br>
                        <div class="col-sm-10">
                            <button class="btn btn-primary" type="submit" name="action" value="settings">Save settings!</button>
                        </div>
                    </div>
                </div>

            </form>
      </div>
      <div class="modal-footer bg-dark">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Invite User Modal ---->
<div class="modal fade" id="inviteUserModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content" style="background:deepskyblue">
      <div class="modal-header bg-dark" style="color:deepskyblue">
        <h5 class="modal-title" id="exampleModalLabel">Invite User</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body bg-dark">
        <form class="form-horizontal" role="form" action="inviteuser/" method="post">
                {% csrf_token %}
                <div class="form-group">
                    <div class="col-sm-10">
                        <label class="control-label col-sm-12 text-muted">User to invite:</label>
                        <div class="col-sm-10">
                            <input class="form-control" type="text" name="username" placeholder="Username..." value="">
                        </div>
                        <br>
                        <div class="col-sm-10">
                            <button class="btn btn-primary" type="submit" name="action" value="inviteUser">Invite user</button>
                        </div>
                    </div>
                </div>

            </form>
      </div>
      <div class="modal-footer bg-dark">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

    <script>
        $(function() {
            $("#votedMovies").hide();
             $('[data-toggle="tooltip"]').tooltip();

            //CSRF
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie != '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) == (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            var csrftoken = getCookie('csrftoken');
            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }

            $("#sendMessageBtn").click(function() {
                var text = $("#chatMessage").val();
                console.log(text);
                $("#chatWindow").append('<p><b> {{ user.username }} </b>( <i>{% now "D M Y H:i" %}</i> ) : ' + text + '</p>')
                $('#chatWindow').stop().animate({
                    scrollTop: $('#chatWindow')[0].scrollHeight
                }, 800);
                $("#chatMessage").val("");
            });


            // Calculate votes, show results
            $("#voteResultsBtn").click(function() {
            console.log('voteResultsBtn');
            {% comment %}$.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });{% endcomment %}
            $.ajax({
                url : './get_vote_results/',
                type : "GET"
            }).done(function(returned_data){

                var votes = returned_data;

                console.log(votes[0].movie.poster);

                function getMovieDiv (index, color, colSize, hSize, icon) {

                    return '<div class="col-lg-' + colSize + ' p-0 mb-4">' +
                                '<div>' +
                                    '<div class="col-lg-12 text-center">' +
                                        '<h' + hSize + ' class="text-light mb-0 pt-1 pb-1">' + icon + votes[index].points + ' points</h' + hSize + '>' +
                                        '<p class="text-light mb-0 pt-1 pb-1">' + votes[index].movie.title + ' (' + votes[index].movie.year + ')</p>' +
                                    '</div>' +
                                    '<div class="col-lg-12 text-center">' +
                                        '<img class="img-fluid text-light text-center" id="resultPoster" data-toggle="tooltip" title="Teee" src="' + votes[index].movie.poster + '" alt="Missing movie poster">' +
                                    '</div>' +
                                '</div>' +
                            '</div>';
                }

                //TODO: SORT BY POINTS
                for(var i = 0; i < returned_data.length; i++) {
                    if(i == 0) {
                        $("#votedMovies").append(
                            '<div class="row" id="movieRow">' +
                            getMovieDiv(i, "goldenrod", 4, 3, '<i class="fas fa-trophy" aria-hidden="true" style="color:gold"></i> ')
                            + '</div>'
                        );
                    } else if(i == 1) {
                        $("#movieRow").append(
                            getMovieDiv(i, "silver", 4, 3, '<i class="fas fa-trophy" aria-hidden="true" style="color:silver"></i> ')
                        );
                    } else if(i == 2) {
                        $("#movieRow").append(
                            getMovieDiv(i, "maroon", 4, 3, '<i class="fas fa-trophy" aria-hidden="true" style="color:maroon"></i> ')
                        );
                    } else {
                        $("#movieRow").append(
                            getMovieDiv(i, "grey", 2, 5, "")
                        );
                    }
                }
                $("#votedMovies").show();
                    setTimeout(function(){
                        var votedMoviesY = $("#votedMovies").offset().top;
                        window.scrollTo(0, votedMoviesY);
                    }, 70);
            });
        });

        });


    </script>

{% endblock %}